networks:
  von:
    external: true
  governance-network:
    driver: bridge

services:
  
  ####### ACAPY ########

  ## GOVERNANCE ##
  ledger-bootstrap-endorser:
    image: appropriate/curl
    container_name: ssi-bootstrap-endorser
    networks:
      - von
    entrypoint: >
      sh -c "
        until curl -sf http://webserver:8000/genesis > /dev/null; do
          echo 'Aguardando von-network...';
          sleep 2;
        done;
        curl -X POST http://webserver:8000/register -H 'Content-Type: application/json' -d '{\"seed\": \"00000000000000GovernanceEndorser\",\"role\": \"TRUSTEE\",\"alias\": \"GovernanceEndorser\"}';
      "
    restart: "no"

  endorser:
    image: ghcr.io/openwallet-foundation/acapy-agent:py3.12-1.3.0
    container_name: ssi-governance-endorser
    depends_on:
      ledger-bootstrap-endorser:
        condition: service_completed_successfully
    ports:
      - "8021:8021"
    networks:
      - von
    environment:
      - LEDGER_URL=http://webserver:8000
      - ACAPY_ADMIN_API_KEY=ffbe0d09b05b46b442a82199206a8c9df97e513c06f05dd85075003430221fc6
      - ACAPY_SEED=00000000000000GovernanceEndorser
    volumes:
      - endorser-wallet:/home/indy/.indy_client/wallet
      
    command: >
      start
        --label "GovernanceEndorser"
        --endpoint http://endorser:8020
        --inbound-transport http 0.0.0.0 8020
        --outbound-transport http
        --admin 0.0.0.0 8021
        --admin-api-key ffbe0d09b05b46b442a82199206a8c9df97e513c06f05dd85075003430221fc6
        --wallet-type askar
        --wallet-name governance_endorser
        --wallet-key ffbe0d09b05b46b442a82199206a8c9df97e513c06f05dd85075003430221fc6
        --wallet-storage-type default
        --seed 00000000000000GovernanceEndorser
        --genesis-url http://webserver:8000/genesis
        --auto-provision
        --log-level info
        --preserve-exchange-records
        
    healthcheck:
      test: >
        curl -f -H "X-API-Key: ffbe0d09b05b46b442a82199206a8c9df97e513c06f05dd85075003430221fc6"
        http://endorser:8021/status
        || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  ## HOLDER ##
  holder:
    image: ghcr.io/openwallet-foundation/acapy-agent:py3.12-1.3.0
    container_name: ssi-holder
    ports:
      - "8030:8030"
      - "8031:8031"
    networks:
      - von
    environment:
      - LEDGER_URL=http://webserver:8000
      - ACAPY_ADMIN_API_KEY=a0b5441108f85e0e61d7f63ae3ae310dd06615bf6703154949a075d07963e9de
    volumes:
      - holder-wallet:/home/indy/.indy_client/wallet
    
    command: >
      start
        --label "Cornellius Almeida JÃºnior"
        --endpoint http://holder:8030
        --inbound-transport http 0.0.0.0 8030
        --outbound-transport http
        --admin 0.0.0.0 8031
        --admin-api-key a0b5441108f85e0e61d7f63ae3ae310dd06615bf6703154949a075d07963e9de
        --wallet-type askar
        --wallet-name holder.agent
        --wallet-key a0b5441108f85e0e61d7f63ae3ae310dd06615bf6703154949a075d07963e9de
        --wallet-allow-insecure-seed
        --preserve-exchange-records
        --auto-provision
        --genesis-url http://webserver:8000/genesis
        --webhook-url http://holder-api:8000/webhook
        --log-level DEBUG
        --debug-connections
        --auto-accept-invites
        --auto-accept-requests
    
    healthcheck:
      test: >
        curl -f -H "X-API-Key: a0b5441108f85e0e61d7f63ae3ae310dd06615bf6703154949a075d07963e9de"
        http://localhost:8031/status
        || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  ## ISSUER ##
  issuer:
    image: ghcr.io/openwallet-foundation/acapy-agent:py3.12-1.3.0
    container_name: ssi-issuer
    ports:
      - "8040:8040"
      - "8041:8041"
    networks:
      - von
    environment:
      - LEDGER_URL=http://webserver:8000
      - ACAPY_ADMIN_API_KEY=a2c7e16d44782151b7341e490b4ca9ca7ed920e1b305e4b2d942648e8b2f9335
    volumes:
      - issuer-wallet:/home/indy/.indy_client/wallet

    command: >
      start
        --label "IssuerWallet"
        --endpoint http://issuer:8040
        --inbound-transport http 0.0.0.0 8040
        --outbound-transport http
        --admin 0.0.0.0 8041
        --admin-api-key a2c7e16d44782151b7341e490b4ca9ca7ed920e1b305e4b2d942648e8b2f9335
        --public-invites
        --wallet-type askar
        --wallet-name issuer.agent
        --wallet-key a2c7e16d44782151b7341e490b4ca9ca7ed920e1b305e4b2d942648e8b2f9335
        --preserve-exchange-records
        --auto-provision
        --genesis-url http://webserver:8000/genesis
        --log-level DEBUG
        --debug-connections
        --auto-accept-invites
        --auto-accept-requests
    
    healthcheck:
      test: >
        curl -f -H "X-API-Key: a2c7e16d44782151b7341e490b4ca9ca7ed920e1b305e4b2d942648e8b2f9335"
        http://localhost:8041/status
        || exit 1
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  ## VERIFIER ##
  verifier:
    image: ghcr.io/openwallet-foundation/acapy-agent:py3.12-1.3.0
    container_name: ssi-issuer-verifier
    ports:
      - "8050:8050"
      - "8051:8051"
    networks:
      - von
    environment:
      - LEDGER_URL=http://webserver:8000
      - ACAPY_ADMIN_API_KEY=1e2ffb118cc0c8317df5190dd079b9380ceb0edc98bd0fb48c8f2dcba733daca
    volumes:
      - verifier-wallet:/home/indy/.indy_client/wallet
    command: >
        start
        --label "VerifierWallet"
        --endpoint http://verifier:8050
        --inbound-transport http 0.0.0.0 8050
        --outbound-transport http
        --admin 0.0.0.0 8051
        --admin-api-key 1e2ffb118cc0c8317df5190dd079b9380ceb0edc98bd0fb48c8f2dcba733daca
        --public-invites
        --wallet-type askar
        --wallet-name verifier.agent
        --wallet-key 1e2ffb118cc0c8317df5190dd079b9380ceb0edc98bd0fb48c8f2dcba733daca
        --preserve-exchange-records
        --auto-provision
        --genesis-url http://webserver:8000/genesis
        --webhook-url http://verifier-api:8002/webhook
        --log-level DEBUG
        --debug-connections
        --auto-accept-invites
        --auto-accept-requests

  ####### MONGODB ########
  mongodb:
    build:
      context: .
      dockerfile: Dockerfile.mongodb
    container_name: governance-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: governance
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - governance-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  mongo-express:
    image: mongo-express:latest
    container_name: governance-mongo-express
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: admin123
      ME_CONFIG_MONGODB_URL: mongodb://admin:admin123@mongodb:27017/
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: admin123
    depends_on:
      - mongodb
    networks:
      - governance-network

  ####### APPs ########

  ## GOVERNANCE ##
  governance-api:
    build:
      context: ../clients/governance/server
      dockerfile: ../../../docker/Dockerfile.fastapi
    container_name: ssi-governance-api
    environment:
      - MONGODB_HOST=mongodb
      - ADMIN_URL=http://endorser:8021
    ports:
      - "8003:8003"
    networks:
      - von
      - governance-network
    depends_on:
      - endorser
    restart: unless-stopped

  governance-painel:
    build:
      context: ../clients/governance/painel
      dockerfile: ../../../docker/Dockerfile.vue3
      args:
        - VITE_API_BASE_URL=http://localhost:8003/api
        - VITE_APP_NAME=Governance Painel
        - VITE_APP_VERSION=1.0.0
    container_name: ssi-governance-painel
    ports:
      - "3003:80"
    networks:
      - von
    depends_on:
      - governance-api
    restart: unless-stopped

  ## HOLDER ##
  holder-api:
    build:
      context: ../clients/holder/server
      dockerfile: ../../../docker/Dockerfile.fastapi
    container_name: ssi-holder-api
    environment:
      - ADMIN_URL=http://holder:8031
    ports:
      - "8000:8000"
    networks:
      - von
    depends_on:
      - holder
    restart: unless-stopped

  holder-painel:
    build:
      context: ../clients/holder/painel
      dockerfile: ../../../docker/Dockerfile.vue3
      args:
        - VITE_API_BASE_URL=http://localhost:8000/api
        - VITE_APP_NAME=Holder Painel
        - VITE_APP_VERSION=1.0.0
    container_name: ssi-holder-painel
    ports:
      - "3000:80"
    networks:
      - von
    depends_on:
      - holder-api
    restart: unless-stopped

  ## ISSUER ##
  issuer-api:
    build:
      context: ../clients/issuer/server
      dockerfile: ../../../docker/Dockerfile.fastapi
    container_name: ssi-issuer-api
    environment:
      - GOVERNANCE_URL=http://governance-api:8003
      - ADMIN_URL=http://issuer:8041
    ports:
      - "8001:8001"
    networks:
      - von
    depends_on:
      - issuer
    restart: unless-stopped

  issuer-painel:
    build:
      context: ../clients/issuer/painel
      dockerfile: ../../../docker/Dockerfile.vue3
      args:
        - VITE_API_BASE_URL=http://localhost:8001/api
        - VITE_APP_NAME=Issuer Painel
        - VITE_APP_VERSION=1.0.0
    container_name: ssi-issuer-painel
    ports:
      - "3001:80"
    networks:
      - von
    depends_on:
      - issuer-api
    restart: unless-stopped

  ## VERIFIER ##
  verifier-api:
    build:
      context: ../clients/issuer-verifier/server
      dockerfile: ../../../docker/Dockerfile.fastapi
    container_name: ssi-verifier-api
    environment:
      - GOVERNANCE_URL=http://governance-api:8003
      - ADMIN_URL=http://verifier:8051
    ports:
      - "8002:8002"
    networks:
      - von
    depends_on:
      - verifier
    restart: unless-stopped

  verifier-painel:
    build:
      context: ../clients/issuer-verifier/painel
      dockerfile: ../../../docker/Dockerfile.vue3
      args:
        - VITE_API_BASE_URL=http://localhost:8002/api
        - VITE_APP_NAME=Verifier Painel
        - VITE_APP_VERSION=1.0.0
    container_name: ssi-verifier-painel
    ports:
      - "3002:80"
    networks:
      - von
    depends_on:
      - verifier-api
    restart: unless-stopped

volumes:
  endorser-wallet:
  holder-wallet:
  issuer-wallet:
  verifier-wallet:
  mongodb_data:
  mongodb_config:
    driver: local
