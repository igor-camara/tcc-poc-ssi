from modules.webhook.schema import Notification
from modules.client.service import AcaPyClient

def process_issue_credential_v2_0(body: dict):
    try:
        print(body['state'])
        if not 'state' in body:
            return None
        
        if body['state'] == 'offer-received':
            return receive_offer(body)
        if body['state'] == 'credential-received':
            print("Storing received credential...")
            return store_credential(body)
        
        return None
        
    except Exception as e:
        print(f"Erro ao processar issue credential v2.0: {str(e)}")
        raise e
    
def receive_offer(body: dict):
    if 'by_format' in body:
        by_format = body.get('by_format', {})
        
        if 'cred_offer' in by_format:
            indy_offer = by_format['cred_offer'].get('indy', {})
            schema_id = indy_offer.get('schema_id')
            cred_def_id = indy_offer.get('cred_def_id')
        
        if not schema_id and 'cred_proposal' in by_format:
            indy_proposal = by_format['cred_proposal'].get('indy', {})
            schema_id = indy_proposal.get('schema_id')
            cred_def_id = indy_proposal.get('cred_def_id')
        
        if not schema_id and 'cred_issue' in by_format:
            indy_issue = by_format['cred_issue'].get('indy', {})
    
    notification = Notification(
        tipo="offer-received",
        connection_id=body.get('connection_id'),
    )
    
    notification.save()

    return notification.to_dict()

def store_credential(body: dict):
    cred_ex_id = body.get('cred_ex_id')
    result = AcaPyClient.issue.store_credential(cred_ex_id)

    print(result)

    notification = Notification(
        tipo="credential-received",
        connection_id=body.get('connection_id'),
    )
    
    notification.save()

    return None


#process_issue_credential_v2_0({'connection_id': 'cf1f3341-1c12-4297-9540-26135c639e12', 'cred_ex_id': '7587563b-e304-4efe-b5c2-573f31a638e5', 'role': 'holder', 'initiator': 'external', 'auto_offer': False, 'auto_issue': False, 'auto_remove': True, 'thread_id': '1186c6b9-0f3e-4c95-87df-c8a5f838974b', 'state': 'request-sent', 'by_format': {'cred_offer': {'indy': {'schema_id': '4fUDR9R7fjwELRvH9JT6HH:2:Certificado de Conclusão:5.0', 'cred_def_id': '4fUDR9R7fjwELRvH9JT6HH:3:CL:43:default', 'key_correctness_proof': {'c': '3440133059160887624521554047734824210626903121974088351011395899974177716187', 'xz_cap': '42255742400154976720138461776248530384266559277842195813584044628109866586110931470208520247421071393085673233834180725160777460658475809169321091629537111021773938082900793141567694510313288333634230182666140679401021008936788420161007403017640294156850162159153520754873841079129214183545018034711132520578572086165675292347911825527444179226626382577831966170453394992597964115306800636039552838019300824779288969198885453222424988503920135730380720959241995246038710022226046656655359252590023846136475752091742439525980697060225407807294431363302882575339196029227538863305970315221884562453001278352722020949429708409722759473248174486519960966543382723596990924188182946435840795835994', 'xr_cap': [['ano', '53175180217577845061935422204586014521075806664576387915382033839645360316418331503881939810421516647566284073816916200842956046191533850791661842891786737298967932951643228485713043569570485089414564914487019704713151629977016881189528846400331852117164125212550723517955954540515656771665225823082407539899633815767492460384971807724774965117426032563305120796677354459298897872306047866798876687817001496905142487759441082420413945447078851417133674022126154200376977943092753652898785490118016042427965997105378191527976986154612026888930945167047296736678976461379989922196130332305967097233007151768392138702738545679642010498335551698336144259940844406563720263049045999401243628199926'], ['matrícula', '39527610296329085083006216896528447633672373082267335398696818034863828681568344057456124154193651843781175072646388476162658343572214646294955281510419656991345632655187150064308031898537980413519574492549129438864381117378121905307685707005855431038709209006694764460270677338517766253446903835965209171788087203180432234109125683145948401436295742513505197068774089839462909919545520864394981810552018692778778125860099553853455506710994076421050261177453146582348457372107216560823168832535283859829888400761831450177515912773779438319883171828426200123358736788406937094704793178994264846976667765465465070600111112716823565273786448922816929351864673654350903722903830275482230397744514'], ['curso', '63702792795012470123819777071860588699441954398799030592394184472890776952999421769767940400320416523508701739588527933990939619705682915398514531557775272985159553560403587433500002670948942712880649535419096704726836225016587999650847082333267466054172726816781422620993967917723903614769290141866213258237553208053437785130995858333614969793883101255815332835583952500292696361031230236858148019726535330893423967616937284660667308624615497537978642661568896800858279629442366870755225710161462191942698104739471563577814289823704449980006992540985700296353439520715412495753703534658336394936394249949485949861943916510972863912128207829524580536342349428565571802438256058363193597766675'], ['master_secret', '20902550776658197973734593510763721472003976492282644821419840131691640039024876379347793640377036703713141364270674113114777654308361643886517717787025411411544577543639510160921655033095608188443614644957547167119988096842257502988861173219670671012643488885100969051086006639312380731536732220257592774460056428503441937962092900251011875600956335953668635843165289684496574531937852867854089777883877195742736900514026687220477952855839560962115318722778550388495263960064543134723251265001974754776285602173568506386372290125455855284247864227572855388699821831184678794226580222385945054157539236296509313663571170923282148237080099656028967837412198412190726855482742776700191753969832']]}, 'nonce': '822570162082899806558992'}}, 'cred_request': {'indy': {'prover_did': 'D9u7xQkvYgUAfii5cHsTCh', 'cred_def_id': '4fUDR9R7fjwELRvH9JT6HH:3:CL:43:default', 'blinded_ms': {'u': '50484318784319584882615713006272204779730822673429787001043194939618998432218692152695668030780999878091616469429556821481015697977817751094754109728131569642064537399264214082317116215140946663395571510492030251821312041309501765432627189515908104312881861863091704833134057222186330556121784877015389158269609755773524446768456977944889264116428857539330832003335261414528545853741220897450076461848468930572906598983896538040495476402749337141872246314311680138396723350579448494003841637104907730554549552852601636947855285831746112907087435412196448843364960169548524907620508402415139238047859378453720919190244', 'ur': None, 'hidden_attributes': ['master_secret'], 'committed_attributes': {}}, 'blinded_ms_correctness_proof': {'c': '25183597284432449731501460416854872713272688359434519265508966388495123725721', 'v_dash_cap': '384450663749752544200538159441380478284961695830540285196617685208373678556627552804513119544225332432767749602767996930419071502083957229547129819268784305421201003663568730589768563329340308674635662491525558343960282714886141437916192389646624489996575089122959975947645146676743241882925765147093607549496193404230140964187032452701328714102445000439750658543343368152045221281387464061494449265567488593115812634457200194321827548319972776557239780812006636221440728307239506907427626951709905201229831540581905828048300580954708586178308464008560072536431857878451779706732563934912193716955068231443611931556797414603201350102547328297886968828996060591089504611660767799243693764727131055509231843668092092627', 'm_caps': {'master_secret': '1038207221864966668376763385403766217668767760541915707102362719591454162117514431858143442908082711224085014504102477743191864773225052311330606629086521408904572555151957153570'}, 'r_caps': {}}, 'nonce': '19902747342608639178167'}}}, 'trace': False, 'created_at': '2025-10-15T02:00:58.384355Z', 'updated_at': '2025-10-15T02:01:08.187696Z'})